<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <title>Title</title>
</head>
<link th:href="@{/webjars/bootstrap/5.1.3/css/bootstrap.css}" th:rel="stylesheet">
<style>

    body {
        overflow-x: hidden;
    }

    #sidebar-wrapper {
        min-height: 100vh;
        margin-left: -15rem;
        -webkit-transition: margin .25s ease-out;
        -moz-transition: margin .25s ease-out;
        -o-transition: margin .25s ease-out;
        transition: margin .25s ease-out;
    }

    #sidebar-wrapper .sidebar-heading {
        padding: 0.875rem 1.25rem;
        font-size: 1.2rem;
    }

    #sidebar-wrapper .list-group {
        width: 15rem;
    }

    #page-content-wrapper {
        min-width: 100vw;
    }


    @media (min-width: 768px) {
        #sidebar-wrapper {
            margin-left: 0;
        }

        #page-content-wrapper {
            min-width: 0;
            width: 100%;
        }
    }
</style>
<body>
<div class="col-12">
    <div class="d-flex" id="wrapper">
        <div class="bg-dark border-right vh-100 h-100 overflow-auto" id="sidebar-wrapper">
            <div class="text-light sidebar-heading">Documents</div>
            <a class="list-group-item sidebar-heading list-group-item-action text-light bg-secondary"
               data-bs-toggle="collapse"
               href="#sidebar-nav-users" role="button" aria-expanded="false" aria-controls="collapseExample">
                Your
            </a>
            <div id="sidebar-nav-users" class="collapse list-group list-group-flush show">
            </div>
            <a class="list-group-item sidebar-heading list-group-item-action text-light bg-dark"
               data-bs-toggle="collapse"
               href="#sidebar-nav" role="button" aria-expanded="false" aria-controls="collapseExample">
                All
            </a>
            <div id="sidebar-nav" class="collapse list-group list-group-flush">
            </div>

        </div>
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg .navbar-dark bg-dark border-bottom">
                <button id="upload-button" class="btn-dark form-control" onclick="uploadDocument();">Upload document
                </button>
                <label for="formFile" class="form-label">File input</label>
                <input class="form-control" type="file" id="formFile">
            </nav>
            <div class="container-fluid">
                <div class="col-12">
                    <a>You can find your uploaded in "Your" tab!</a>
                    <canvas id="myChart" class="col-6"></canvas>
                </div>
                <div id="file-content" class="col-12">
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.6.0/chart.min.js"></script>
<script th:src="@{/webjars/popper.js/2.9.3/umd/popper.min.js}"></script>
<script th:src="@{/webjars/bootstrap/5.1.3/js/bootstrap.min.js}"></script>
<script>
    window.addEventListener('load', function () {
        populateSidebar();
        populateUserSidebar();
        // startRefreshingSidebar()
        setupCanvas();
        initiateFlux();
    });

    async function startRefreshingUserSidebar() {
        let sidebar_nav = document.getElementById("sidebar-nav-users");
        while (sidebar_nav.childElementCount < getUserUUIDs().length) {
            await populateUserSidebar()
            await new Promise(r => setTimeout(r, 2000));
        }
    }

    // async function startRefreshingSidebar() {
    //     while (true) {
    //         await populateSidebar()
    //         let minute = 60 * 1000
    //         await new Promise(r => setTimeout(r, minute));
    //     }
    // }

    function initiateFlux() {
        var sidebar = document.getElementById("sidebar-nav");

        var source = new EventSource("http://localhost:8080/document/listflux");
        source.addEventListener("message", function(event) {
            let event_data = JSON.parse(JSON.parse(event.data).parameter)
            let new_entry =
                "            <a title=" + event_data.uuid + " onclick=\"getGraph(this);\" href=\"#\"\n" +
                "               class=\"list-group-item list-group-item-action text-light bg-dark\">\n" +
                "                <span>" + event_data.title + "</span>\n" +
                "            </a>"
            console.log(event_data)
            sidebar.innerHTML = new_entry + sidebar.innerHTML;
        });
    }

    async function populateUserSidebar() {
        var user_uuids = getUserUUIDs();
        const response = await fetch('http://localhost:8080/document/list', {
            method: 'POST',
            body: JSON.stringify(user_uuids),
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const myJson = await response.json();

        let sidebar_nav = document.getElementById("sidebar-nav-users");
        var new_sidebar = "";
        for (let i = 0; i < myJson.length; i++) {
            new_sidebar +=
                "            <a title=" + myJson[i].uuid + " onclick=\"getGraph(this);\" href=\"#\"\n" +
                "               class=\"list-group-item list-group-item-action text-light bg-dark\">\n" +
                "                <span>" + myJson[i].title + "</span>\n" +
                "            </a>"
        }
        sidebar_nav.innerHTML = new_sidebar
        return myJson
    }

    async function populateSidebar() {
        const response = await fetch('http://localhost:8080/document/all', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const myJson = await response.json();

        let sidebar_nav = document.getElementById("sidebar-nav");
        var new_sidebar = "";
        for (let i = 0; i < myJson.length; i++) {
            new_sidebar +=
                "            <a title=" + myJson[i].uuid + " onclick=\"getGraph(this);\" href=\"#\"\n" +
                "               class=\"list-group-item list-group-item-action text-light bg-dark\">\n" +
                "                <span>" + myJson[i].title + "</span>\n" +
                "            </a>"
        }
        sidebar_nav.innerHTML = new_sidebar
    }

    function updateStorage(uuid) {
        if (uuid !== null) {
            let storage = window.localStorage;
            let uuids = JSON.parse(storage.getItem("UUIDs"));
            if (uuids !== null) {
                uuids.push(uuid)
                storage.setItem("UUIDs", JSON.stringify(uuids))
            } else {
                let newListOfUUIDs = [uuid]
                storage.setItem("UUIDs", JSON.stringify(newListOfUUIDs))
            }
        }
    }

    function getUserUUIDs() {
        let storage = window.localStorage;
        return JSON.parse(storage.getItem("UUIDs"))
    }

    async function uploadDocument() {
        resetUploadButtonText();
        var input = document.querySelector('input[type="file"]')
        if (input.files[0] !== undefined) {
            var data = new FormData()
            data.append('file', input.files[0])
            document.getElementById("upload-button").disabled = true
            const response = await fetch('/upload/file', {
                method: 'POST',
                body: data
            }).then(resp => {
                document.getElementById("upload-button").disabled = false
                if (resp.status === 200) {
                    setUploadButtonText("Upload successful")
                } else {
                    setUploadButtonText("Upload failed")
                }
                populateUserSidebar()
                return resp
            })
            let json = await response.json()
            if (json.uuid !== -1) {
                updateStorage(json.uuid)
                startRefreshingUserSidebar()
            }
        } else {
            setUploadButtonText("No file chosen!")
        }
    }

    function setUploadButtonText(text) {
        document.getElementById("upload-button").textContent = text
    }

    function resetUploadButtonText() {
        document.getElementById("upload-button").textContent = "Upload file"
    }

    var myChart;

    async function getGraph(e) {
        var uuid = e.title
        console.log(uuid)
        const response = await fetch('http://localhost:8080/graph/' + uuid, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const myJson = await response.json();
        console.log(myJson)
        myChart.config.options.plugins.title.text = e.text + " " + uuid
        for (let i = 0; i < 20; i++) {
            removeData()
        }

        createLoadDataButton(uuid)
        addData(myJson)
        let sampleSize = getSampleSize(myJson);
        console.log(sampleSize)
        await getIdealBenfordGraph(sampleSize)
    }

    function getSampleSize(json) {
        return json.onesCount+
        json.twosCount +
        json.threesCount +
        json.foursCount +
        json.fivesCount +
        json.sixesCount +
        json.sevensCount +
        json.eightsCount +
        json.ninesCount;
    }

    async function getIdealBenfordGraph(sampleSize) {
        const response = await fetch('http://localhost:8080/graph/ideal/' + sampleSize, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const json = await response.json();
        console.log(json)
        addDataToBaselineBenford(json)
    }

    function createLoadDataButton(uuid) {
        let fileContent = document.getElementById("file-content");
        fileContent.innerHTML = "<button class=\"btn-dark form-control\" onclick=\"loadFileContent('" + uuid + "');\">Load data</button>"
    }

    async function loadFileContent(uuid) {
        let response = await fetch('http://localhost:8080/document/content/' + uuid, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        console.log(response)
        const json = await response.json()
        console.log(json)
        let newDivContent = "";
        for (let i = 0; i < json.length; i++) {
            newDivContent += "<a>"+json[i]+"</a>"
        }
        fileContent.innerHTML = newDivContent;
    }

    function addData(json) {
        myChart.data.datasets.forEach((dataset) => {
            if (dataset.label === 'Input') {
                if(json.matchesBenfordLaw) {
                    dataset.borderColor= 'rgba(0,255,229,0.24)'
                    dataset.backgroundColor= 'rgba(0,255,255,0.42)'
                } else {
                    dataset.borderColor= 'rgba(255,0,38,0.24)'
                    dataset.backgroundColor= 'rgba(255,0,47,0.42)'
                }
                dataset.data.push(json.onesCount);
                dataset.data.push(json.twosCount);
                dataset.data.push(json.threesCount);
                dataset.data.push(json.foursCount);
                dataset.data.push(json.fivesCount);
                dataset.data.push(json.sixesCount);
                dataset.data.push(json.sevensCount);
                dataset.data.push(json.eightsCount);
                dataset.data.push(json.ninesCount);
            }
        });
        myChart.update();
    }

    function addDataToBaselineBenford(json) {
        myChart.data.datasets.forEach((dataset) => {
            if (dataset.label === 'Benford') {
                dataset.data.push(json.onesCount);
                dataset.data.push(json.twosCount);
                dataset.data.push(json.threesCount);
                dataset.data.push(json.foursCount);
                dataset.data.push(json.fivesCount);
                dataset.data.push(json.sixesCount);
                dataset.data.push(json.sevensCount);
                dataset.data.push(json.eightsCount);
                dataset.data.push(json.ninesCount);
            }
        });
        myChart.update();
    }

    function removeData() {
        // myChart.data.labels.pop();
        myChart.data.datasets.forEach((dataset) => {
                dataset.data = []
        });
        myChart.update();
    }

    function setupCanvas() {
        const ctx = document.getElementById('myChart').getContext('2d');
        const labels = ["1", "2", "3", "4", "5", "6", "7", "8", "9"]
        const data = {
            labels: labels,
            datasets: [
                {
                    label: 'Input',
                    data: [],
                    borderColor: 'rgba(0,255,229,0.24)',
                    backgroundColor: 'rgba(0,255,255,0.42)'
                }
                ,
                {
                    label: 'Benford',
                    data: [],
                    borderColor: 'rgba(225,190,106,0.42)',
                    backgroundColor: 'rgba(225,190,106,0.71)'
                }
            ]
        };
        const config = {
            type: 'bar',
            data: data,
            options: {
                indexAxis: 'y',
                // Elements options apply to all of the options unless overridden in a dataset
                // In this case, we are setting the border of each horizontal bar to be 2px wide
                elements: {
                    bar: {
                        borderWidth: 2,
                    }
                },
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    title: {
                        display: true,
                        text: 'Chart.js Horizontal Bar Chart'
                    }
                }
            },
        };
        myChart = new Chart(ctx, config);
        console.log("Chart set up!")
    }

</script>
</html>
